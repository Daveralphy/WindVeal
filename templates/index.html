<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dave Chatbot - Home</title>
    <!-- Favicon and Web App Manifest links -->
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="manifest" href="/static/site.webmanifest">
    <!-- Link to external style.css -->
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="flex flex-col min-h-screen">
    <div class="app-wrapper">
        <header class="header">
            <h1>Dave</h1>
            <button id="new-chat-btn" class="new-chat-btn">New Chat</button> <!-- Initially hidden, JS controls -->
            <div class="menu-container">
                <button id="menu-btn" class="menu-btn">
                    <div class="hamburger-icon">
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                    </div>
                    Menu
                </button>
                <div id="side-menu" class="side-menu">
                    <a href="#" id="login-link" class="menu-item hidden"><i class="fas fa-sign-in-alt"></i> Login</a> <!-- Initially hidden, JS controls -->
                    <a href="#" id="profile-link" class="menu-item hidden"><i class="fas fa-user-circle"></i> User Profile</a> <!-- Initially hidden, JS controls -->
                    <a href="#" id="settings-link" class="menu-item"><i class="fas fa-cog"></i> Settings</a>
                    <a href="#" id="about-link" class="menu-item"><i class="fas fa-info-circle"></i> About Dave</a>
                    <a href="#" id="menu-logout-link" class="menu-item hidden"><i class="fas fa-sign-out-alt"></i> Logout</a> <!-- Initially hidden, JS controls -->
                </div>
            </div>
        </header>

        <main class="content-area">
            <!-- The chat section is always the main content now -->
            <div id="chat-section" class="chat-section">
                <div class="chat-box" id="chat-box"></div>
                <form id="chat-form" class="chat-input-area">
                    <button type="button" id="upload-btn" class="btn upload-btn" title="Attach file"><i class="fas fa-paperclip"></i></button>
                    <input type="text" id="user-input" placeholder="Message Dave..." class="user-input-field" autocomplete="off">
                    <button type="submit" class="btn send-btn" title="Send message"><i class="fas fa-paper-plane"></i></button>
                </form>
                <p class="disclaimer-text">Dave can make mistakes. Chat with consideration.</p>
            </div>
        </main>
    </div>

    <div id="overlay" class="overlay"></div>

    <!-- NEW: Authentication Modal (Login/Register) -->
    <div id="auth-modal" class="modal-container">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <div class="modal-icon"><i class="fas fa-user-circle"></i></div> <!-- Icon for Auth -->
            <h2 id="auth-title" class="text-center">Welcome! Please log in or register.</h2>
            <form id="auth-form">
                <div class="input-group">
                    <label for="username" id="username-label">Username:</label>
                    <input type="text" id="username" name="username" required autocomplete="username">
                </div>
                <div class="input-group" id="email-input-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" autocomplete="email">
                </div>
                <!-- Password input with toggle -->
                <div class="input-group password-input-group">
                    <label for="password">Password:</label>
                    <div class="relative w-full">
                        <input type="password" id="password" name="password" required autocomplete="current-password" class="w-full pr-12">
                        <span class="password-toggle-icon absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer">
                            <i class="fas fa-eye" id="toggle-password-icon"></i>
                        </span>
                    </div>
                </div>
                <!-- Confirm Password input with toggle -->
                <div class="input-group password-input-group" id="confirm-password-group">
                    <label for="confirm-password">Confirm Password:</label>
                    <div class="relative w-full">
                        <input type="password" id="confirm-password" name="confirm-password" autocomplete="new-password" class="w-full pr-12">
                        <span class="password-toggle-icon absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer">
                            <i class="fas fa-eye" id="toggle-confirm-password-icon"></i>
                        </span>
                    </div>
                </div>
                <button type="submit" id="auth-button" class="btn primary-btn">Login</button>
                <p id="auth-message" class="message"></p>
                <div class="toggle-auth">
                    <a href="#" id="toggle-auth-link" class="link-btn">Don't have an account? Register</a>
                </div>
            </form>
        </div>
    </div>
    <!-- END NEW Authentication Modal -->

    <!-- Existing Login Required Modal (for message limit prompt) -->
    <div id="login-required-modal" class="modal-container">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <div class="modal-icon"><i class="fas fa-lock"></i></div>
            <h2 class="text-center">Login Required</h2>
            <p class="login-required-disclaimer">You've reached the limit of <span id="message-limit">5</span> free messages</p>
            <form id="login-required-form">
                <div class="input-group">
                    <label for="login-required-username">Username or Email:</label>
                    <input type="text" id="login-required-username" name="username" required autocomplete="username">
                </div>
                <!-- Login Required Password input with toggle -->
                <div class="input-group password-input-group">
                    <label for="login-required-password">Password:</label>
                    <div class="relative w-full">
                        <input type="password" id="login-required-password" name="password" required autocomplete="current-password" class="w-full pr-12">
                        <span class="password-toggle-icon absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer">
                            <i class="fas fa-eye" id="toggle-login-required-password-icon"></i>
                        </span>
                    </div>
                </div>
                <div class="flex justify-between items-center text-sm mt-2">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="remember-me" name="remember-me">
                        <span>Remember me</span>
                    </label>
                    <a href="#" id="forgot-password-link" class="link-btn">Forgot password?</a>
                </div>
                <button type="submit" class="btn primary-btn mt-4">Log in</button>
                <p class="or-separator">Or continue with</p>
                <div class="login-required-social-options">
                    <button type="button" class="social-icon-btn" title="Sign in with GitHub"><i class="fab fa-github"></i></button>
                    <button type="button" class="social-icon-btn" title="Sign in with Twitter"><i class="fab fa-twitter"></i></button>
                    <button type="button" class="social-icon-btn" title="Sign in with Google"><i class="fab fa-google"></i></button>
                </div>
                <div class="toggle-auth mt-4">
                    <a href="#" id="toggle-auth-modal-link" class="link-btn">Don't have an account? Register</a>
                </div>
            </form>
        </div>
    </div>


    <div id="profile-modal" class="modal-container">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <div class="modal-icon"><i class="fas fa-user"></i></div>
            <h2 class="text-center">User Profile</h2>
            <p class="text-center" id="profile-display-name">Loading...</p>
            <p class="text-center" id="profile-email">Loading...</p>
            <div class="input-group">
                <label for="profile-display-name-input">Display Name</label>
                <input type="text" id="profile-display-name-input" value="">
            </div>
            <div class="input-group">
                <label for="profile-email-input">Email</label>
                <input type="email" id="profile-email-input" value="">
            </div>
            <a href="#" class="link-btn text-center mt-4" id="change-password-link">Click to change password</a>
            <button class="btn primary-btn mt-4">Update Profile</button>
        </div>
    </div>

    <div id="settings-modal" class="modal-container">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <div class="modal-icon"><i class="fas fa-cog"></i></div>
            <h2 class="text-center">Settings</h2>
            <div class="settings-option">
                <label for="theme-toggle" class="theme-label">Theme:</label>
                <div class="toggle-switch-wrapper">
                    <input type="checkbox" id="theme-toggle" class="toggle-switch-checkbox">
                    <label for="theme-toggle" class="toggle-switch-label">
                        <span class="toggle-switch-inner"></span>
                        <span class="toggle-switch-slider"></span>
                    </label>
                </div>
            </div>
            <div class="settings-option">
                <label for="language-select">Language</label>
                <select id="language-select" class="settings-dropdown">
                    <option value="en">English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                </select>
            </div>
            <div class="settings-option">
                <label for="font-size-select">Font Size</label>
                <select id="font-size-select" class="settings-dropdown">
                    <option value="small">Small</option>
                    <option value="medium">Medium</option>
                    <option value="large">Large</option>
                </select>
            </div>
            <div class="settings-option">
                <label for="notifications-toggle">Notifications</label>
                <div class="toggle-switch-wrapper">
                    <input type="checkbox" id="notifications-toggle" class="toggle-switch-checkbox" checked title="Enable or disable notifications">
                    <label for="notifications-toggle" class="toggle-switch-label">
                        <span class="toggle-switch-inner"></span>
                        <span class="toggle-switch-slider"></span>
                    </label>
                </div>
            </div>
            <div class="settings-option">
                <label for="sound-effects-toggle">Sound Effects</label>
                <div class="toggle-switch-wrapper">
                    <input type="checkbox" id="sound-effects-toggle" class="toggle-switch-checkbox">
                    <label for="sound-effects-toggle" class="toggle-switch-label">
                        <span class="toggle-switch-inner"></span>
                        <span class="toggle-switch-slider"></span>
                    </label>
                </div>
            </div>
            <button class="btn primary-btn mt-4">Save Settings</button>
        </div>
    </div>

    <div id="about-modal" class="modal-container">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <div class="modal-icon"><i class="fas fa-comment-dots"></i></div>
            <h2 class="text-center">Dave v1.0</h2>
            <p class="text-center">A powerful AI assistant designed to help with your questions and tasks.</p>
            <ul class="list-none space-y-2 mt-4 text-center">
                <li><i class="fas fa-check-circle text-green-500 mr-2"></i> Natural language understanding</li>
                <li><i class="fas fa-check-circle text-green-500 mr-2"></i> Contextual conversations</li>
                <li><i class="fas fa-check-circle text-green-500 mr-2"></i> Personalized responses</li>
                <li><i class="fas fa-check-circle text-green-500 mr-2"></i> Continuous learning</li>
            </ul>
            <p class="text-center text-xs text-gray-500 mt-2">&copy; 2025 Dave AI</p>
            <p class="text-center text-xs text-gray-500">All rights reserved</p>
        </div>
    </div>


    <script>
        // --- Common JavaScript Elements and Functions ---
        const newChatBtn = document.getElementById('new-chat-btn');
        const menuBtn = document.getElementById('menu-btn');
        const menuContainer = document.querySelector('.menu-container');
        const sideMenu = document.getElementById('side-menu');
        const menuLogoutLink = document.getElementById('menu-logout-link');
        const overlay = document.getElementById('overlay');
        const body = document.body;

        const loginLink = document.getElementById('login-link');
        const profileLink = document.getElementById('profile-link');
        const settingsLink = document.getElementById('settings-link');
        const aboutLink = document.getElementById('about-link');

        const profileModal = document.getElementById('profile-modal');
        const settingsModal = document.getElementById('settings-modal');
        const aboutModal = document.getElementById('about-modal');
        const loginRequiredModal = document.getElementById('login-required-modal');

        const modalCloseBtns = document.querySelectorAll('.modal-container .modal-close-btn');

        const profileDisplayNameInput = document.getElementById('profile-display-name-input');
        const profileEmailInput = document.getElementById('profile-email-input');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileEmail = document.getElementById('profile-email');


        const themeToggle = document.getElementById('theme-toggle');

        const messageLimitSpan = document.getElementById('message-limit');

        // NEW: Reference to the main authentication modal
        const authModal = document.getElementById('auth-modal');

        // Main auth form links/elements (now inside authModal)
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const usernameInput = document.getElementById('username');
        const usernameLabel = document.getElementById('username-label');
        const emailInputGroup = document.getElementById('email-input-group');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password'); // Main form password input
        const confirmPasswordGroup = document.getElementById('confirm-password-group'); // Main form confirm password group
        const confirmPasswordInput = document.getElementById('confirm-password'); // Main form confirm password input
        const authButton = document.getElementById('auth-button');
        const authMessage = document.getElementById('auth-message');
        const toggleAuthLink = document.getElementById('toggle-auth-link'); // Main form toggle link

        // Login Required Modal specific elements
        const loginRequiredUsernameInput = document.getElementById('login-required-username');
        const loginRequiredPasswordInput = document.getElementById('login-required-password');
        const loginRequiredForm = document.getElementById('login-required-form');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const toggleAuthModalLink = document.getElementById('toggle-auth-modal-link'); 

        // Password toggle icons
        const togglePasswordIcon = document.getElementById('toggle-password-icon');
        const toggleConfirmPasswordIcon = document.getElementById('toggle-confirm-password-icon');
        const toggleLoginRequiredPasswordIcon = document.getElementById('toggle-login-required-password-icon');

        // Chat section elements (main content, no longer hidden/shown)
        const chatSection = document.getElementById('chat-section'); // Now always visible by default
        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const uploadBtn = document.getElementById('upload-btn');


        let isRegisterMode = false;
        const MAX_GUEST_MESSAGES_FRONTEND = 5;


        // --- UI Display Functions ---
        // showSection no longer hides/shows auth-section, only controls chat-section visibility
        function showSection(section) {
            console.log(`Attempted to show section: ${section}. In this setup, chat is usually always visible.`);
        }

        function parseBotMessage(text) {
            let safeText = text.replace(/&/g, '&amp;')
                               .replace(/</g, '&lt;')
                               .replace(/>/g, '&gt;')
                               .replace(/"/g, '&#039;');
            safeText = safeText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            safeText = safeText.replace(/\*(.*?)\*/g, '<em>$1</em>');
            safeText = safeText.replace(/\n/g, '<br>');
            return safeText;
        }

        function displayMessage(msg, type = 'info') {
            const messageBox = document.createElement('div');
            messageBox.classList.add('custom-message-box', type);
            messageBox.textContent = msg;
            document.body.appendChild(messageBox);

            setTimeout(() => {
                messageBox.remove();
            }, 3000);
        }

        function updateSideMenu(loggedIn) {
            if (loginLink) loginLink.style.display = 'none';
            if (profileLink) profileLink.style.display = 'none';
            if (menuLogoutLink) menuLogoutLink.style.display = 'none';
            if (newChatBtn) newChatBtn.style.display = 'none'; // Default to hidden

            if (loggedIn) {
                if (profileLink) profileLink.style.display = 'flex';
                if (menuLogoutLink) menuLogoutLink.style.display = 'flex';
                if (newChatBtn) newChatBtn.style.display = 'block'; // Show only if logged in
            } else {
                if (loginLink) loginLink.style.display = 'flex';
                // newChatBtn remains hidden for guests
            }
            console.log('Side menu updated. LoggedIn:', loggedIn);
        }

        function openModal(modalElement) {
            console.log('openModal called for:', modalElement ? modalElement.id : 'null element');
            if (!modalElement) {
                console.error('openModal received a null element. Cannot open modal.');
                return;
            }
            // Close any other open modals before opening a new one
            document.querySelectorAll('.modal-container.open').forEach(modal => {
                if (modal !== modalElement) { // Don't close the modal being opened
                    closeModal(modal);
                }
            });
            sideMenu.classList.remove('open'); 
            overlay.classList.add('visible'); 
            modalElement.classList.add('open'); 
            body.classList.add('modal-open'); 
        }

        function closeModal(modalElement) {
            console.log('closeModal called for:', modalElement ? modalElement.id : 'null element');
            if (!modalElement) return;

            modalElement.classList.remove('open');
            body.classList.remove('modal-open');

            // Only hide overlay if no other menu or modal is currently open
            const anyOtherModalOpen = document.querySelectorAll('.modal-container.open').length > 0;
            if (!sideMenu.classList.contains('open') && !anyOtherModalOpen) {
                overlay.classList.remove('visible');
            }
        }


        // --- Authentication Form Logic ---

        // Function to reset the main auth form to login mode
        function resetAuthFormToLoginMode() {
            isRegisterMode = false;
            if (authButton) authButton.textContent = 'Login';
            if (toggleAuthLink) toggleAuthLink.textContent = 'Don\'t have an account? Register';
            if (confirmPasswordGroup) confirmPasswordGroup.style.display = 'none';
            if (confirmPasswordInput) confirmPasswordInput.value = '';
            if (authTitle) authTitle.textContent = 'Welcome! Please log in or register.';
            if (emailInputGroup) emailInputGroup.style.display = 'none';
            if (emailInput) {
                emailInput.value = '';
                emailInput.removeAttribute('required');
            }
            if (usernameLabel) usernameLabel.textContent = 'Username:';
            if (passwordInput) passwordInput.setAttribute('autocomplete', 'current-password');
            if (confirmPasswordInput) confirmPasswordInput.setAttribute('autocomplete', 'new-password');
            if (passwordInput) passwordInput.value = '';
            if (authMessage) authMessage.textContent = '';
        }

        // Function to set the main auth form to register mode
        function setAuthFormToRegisterMode() {
            isRegisterMode = true;
            if (authButton) authButton.textContent = 'Register';
            if (toggleAuthLink) toggleAuthLink.textContent = 'Already have an account? Login';
            if (confirmPasswordGroup) confirmPasswordGroup.style.display = 'block';
            if (authTitle) authTitle.textContent = 'Create Your Account';
            if (emailInputGroup) emailInputGroup.style.display = 'block';
            if (emailInput) {
                emailInput.setAttribute('required', 'true');
            }
            if (usernameLabel) usernameLabel.textContent = 'Username:';
            if (passwordInput) passwordInput.setAttribute('autocomplete', 'new-password');
            if (confirmPasswordInput) confirmPasswordInput.setAttribute('autocomplete', 'new-password');
            if (authMessage) authMessage.textContent = '';
            console.log('Auth form switched to Register mode programmatically.');
        }

        // Handle authentication responses (for both login and register)
        async function handleAuthResponse(response, result, isRegisterAttempt) {
            if (response.ok) {
                if (authMessage) {
                    authMessage.textContent = result.message;
                    authMessage.style.color = 'green';
                }

                if (isRegisterAttempt) {
                    resetAuthFormToLoginMode(); // Switch back to login after successful registration
                    if (authTitle) authTitle.textContent = 'Registration successful! Please log in.';
                    setTimeout(() => {
                        if (authMessage) authMessage.textContent = '';
                    }, 3000);
                } else { // Successful login
                    console.log('Login successful on frontend (handleAuthResponse). Triggering full UI refresh...');
                    closeModal(authModal); 
                    setTimeout(() => {
                        populateChatBoxWithHistoryOrGreeting(); 
                    }, 500); 
                }
            } else {
                if (authMessage) {
                    authMessage.textContent = result.error || 'Authentication failed.';
                    authMessage.style.color = 'red';
                }
                console.error('Authentication failed (handleAuthResponse):', result.error || 'Unknown error');
            }
        }

        // Main Auth Form Submission (Login/Register)
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (authMessage) authMessage.textContent = ''; 

            const username = usernameInput ? usernameInput.value : '';
            const email = emailInput ? emailInput.value : '';
            const password = passwordInput ? passwordInput.value : '';
            let endpoint = '';
            let isRegisterAttempt = false;

            if (isRegisterMode) {
                isRegisterAttempt = true;
                const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : '';
                if (password !== confirmPassword) {
                    if (authMessage) {
                        authMessage.textContent = 'Passwords do not match.';
                        authMessage.style.color = 'red';
                    }
                    return;
                }
                endpoint = '/register';
            } else {
                endpoint = '/login';
            }

            console.log(`Attempting to send ${isRegisterMode ? 'registration' : 'login'} request to ${endpoint}`);

            try {
                const payload = { username, password };
                if (isRegisterMode) {
                    payload.email = email;
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                const result = await response.json();
                console.log('Backend response for authForm submit:', result);
                await handleAuthResponse(response, result, isRegisterAttempt);

            } catch (error) {
                console.error('Authentication Error (authForm submit):', error);
                if (authMessage) {
                    authMessage.textContent = 'An error occurred. Please try again.';
                    authMessage.style.color = 'red';
                }
            }
        });

        // Login Required Modal Form Submission (Login)
        if (loginRequiredForm) {
            loginRequiredForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const usernameOrEmail = loginRequiredUsernameInput.value;
                const password = loginRequiredPasswordInput.value;

                console.log('Attempting to login from Login Required modal.');

                try {
                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username: usernameOrEmail, password: password }),
                    });

                    const result = await response.json();
                    console.log('Backend response for modal login:', result);
                    if (response.ok) {
                        displayMessage('Logged in successfully!', 'success');
                        setTimeout(() => {
                            closeModal(loginRequiredModal); 
                            populateChatBoxWithHistoryOrGreeting(); 
                        }, 500);
                    } else {
                        displayMessage(result.error || 'Login failed from modal. Invalid credentials.', 'error');
                        console.error('Modal login failed:', result.error || 'Unknown error');
                    }
                } catch (error) {
                    console.error('Modal Login Error:', error);
                    displayMessage('An error occurred during modal login.', 'error');
                }
            });
        }

        // Toggle link in main auth form (inside authModal)
        toggleAuthLink.addEventListener('click', (e) => {
            e.preventDefault();
            isRegisterMode = !isRegisterMode; 
            if (authMessage) authMessage.textContent = ''; 
            if (passwordInput) passwordInput.value = ''; 
            if (confirmPasswordInput) confirmPasswordInput.value = '';

            if (isRegisterMode) {
                setAuthFormToRegisterMode(); 
                console.log('Switched to Register mode via main toggle.');
            } else {
                resetAuthFormToLoginMode(); 
                console.log('Switched to Login mode via main toggle.');
            }
        });

        // Toggle link in Login Required Modal (redirects to main authModal in register mode)
        if (toggleAuthModalLink) {
            toggleAuthModalLink.addEventListener('click', (e) => {
                e.preventDefault();
                console.log('Register link clicked inside Login Required modal.');
                closeModal(loginRequiredModal); 
                resetAuthFormToLoginMode(); 
                setAuthFormToRegisterMode(); 
                openModal(authModal); 
            });
        }


        // --- Password Visibility Toggle Logic ---
        function setupPasswordToggle(inputElement, iconElement) {
            if (inputElement && iconElement) {
                iconElement.addEventListener('click', () => {
                    const type = inputElement.getAttribute('type') === 'password' ? 'text' : 'password';
                    inputElement.setAttribute('type', type);
                    iconElement.classList.toggle('fa-eye');
                    iconElement.classList.toggle('fa-eye-slash');
                });
            }
        }

        // Apply password toggle to all relevant fields on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            setupPasswordToggle(passwordInput, togglePasswordIcon);
            setupPasswordToggle(confirmPasswordInput, toggleConfirmPasswordIcon);
            setupPasswordToggle(loginRequiredPasswordInput, toggleLoginRequiredPasswordIcon);
        });


        // --- Chat Functions ---
        function addMessage(sender, message) {
            if (!chatBox) return;

            const messageRow = document.createElement('div');
            messageRow.classList.add('chat-message-row');

            if (sender === 'bot') {
                const iconWrapper = document.createElement('div');
                iconWrapper.classList.add('bot-icon-wrapper');
                iconWrapper.innerHTML = '<i class="fas fa-comment-dots"></i>'; 
                messageRow.appendChild(iconWrapper);
            }

            const messageElement = document.createElement('div');
            messageElement.classList.add('message', sender);
            messageElement.innerHTML = parseBotMessage(message); 
            messageRow.appendChild(messageElement);

            chatBox.appendChild(messageRow);
            chatBox.scrollTop = chatBox.scrollHeight; 
        }

        // Chat Form Submission (sending messages)
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message) return; 

            const currentLoginStatus = await fetch('/check_login_status');
            const currentResult = await currentLoginStatus.json();
            const loggedIn = currentResult.logged_in;
            const backendGuestMessageCount = currentResult.guest_message_count || 0; 

            console.log('Chat submit: User logged in status:', loggedIn, 'Backend Guest message count (before new message):', backendGuestMessageCount);

            if (!loggedIn && backendGuestMessageCount >= MAX_GUEST_MESSAGES_FRONTEND) {
                messageLimitSpan.textContent = 0; 
                openModal(loginRequiredModal); 
                if (userInput.value && (userInput.value.includes('@') || userInput.value.length > 3)) {
                     document.getElementById('login-required-username').value = userInput.value;
                }
                displayMessage('You\'ve reached your free message limit. Please log in!', 'error');
                console.log('Guest message limit reached (backend check). Opening login modal.');
                return; 
            }

            addMessage('user', message); 
            userInput.value = ''; 

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message }),
                });

                const result = await response.json();
                console.log('Chat API response:', result);

                if (response.ok) {
                    addMessage('bot', result.response); 
                    if (!loggedIn) {
                        const updatedLoginStatus = await fetch('/check_login_status');
                        const updatedResult = await updatedLoginStatus.json();
                        if (!updatedResult.logged_in && updatedResult.guest_message_count !== undefined) {
                            guestMessageCount = updatedResult.guest_message_count; 
                            messageLimitSpan.textContent = MAX_GUEST_MESSAGES_FRONTEND - guestMessageCount;
                            if (guestMessageCount >= MAX_GUEST_MESSAGES_FRONTEND) {
                                 openModal(loginRequiredModal); 
                                 console.log('Guest message limit reached (after message sent). Opening login modal.');
                            }
                        }
                    }
                } else if (response.status === 403 && result.code === "LIMIT_EXCEEDED") {
                    displayMessage(result.error, 'error');
                    if (messageLimitSpan) messageLimitSpan.textContent = 0; 
                    openModal(loginRequiredModal);
                    console.error('Backend indicated message limit exceeded.');
                }
                else if (response.status === 401) {
                    displayMessage('Your session has expired or you are unauthorized. Please log in again.', 'error');
                    openModal(authModal); 
                    resetAuthFormToLoginMode(); 
                    console.error('Chat session expired or unauthorized.');
                    return;
                }
                else {
                    addMessage('bot', result.error || 'Oops, something went wrong!');
                }
            } catch (error) {
                console.error('Chat Error:', error);
                addMessage('bot', 'Failed to connect to the chatbot. Please try again.');
            }
        });

        // New Chat Button
        if (newChatBtn) {
            newChatBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                console.log('New Chat button clicked.');
                try {
                    const response = await fetch('/new_chat', { method: 'POST' }); 
                    if (response.ok) {
                        displayMessage('Starting a new chat.', 'info');
                        if (chatBox) chatBox.innerHTML = ''; 

                        const loginStatusResponse = await fetch('/check_login_status');
                        const loginStatusResult = await loginStatusResponse.json();
                        const loggedIn = loginStatusResult.logged_in; // Get loggedIn status here
                        
                        const currentUsername = loginStatusResult.username || 'there';
                        let greetingMessage = '';

                        if (loggedIn) {
                            // Message for logged-in users
                            greetingMessage = `Welcome back, ${currentUsername}! How can I help you today?`;
                            // No need to update messageLimitSpan for logged-in users.
                        } else {
                            // Message for guest users
                            guestMessageCount = loginStatusResult.guest_message_count || 0; 
                            if (messageLimitSpan) messageLimitSpan.textContent = MAX_GUEST_MESSAGES_FRONTEND - guestMessageCount;
                            greetingMessage = `Hello ${currentUsername}! You have ${MAX_GUEST_MESSAGES_FRONTEND - guestMessageCount} free messages left. Please log in for unlimited access.`;
                        }
                        
                        addMessage('bot', greetingMessage); 
                        console.log('New chat initiated successfully with appropriate greeting.'); // Updated log message
                    } else if (response.status === 401) { 
                        displayMessage('You must be logged in to start a new chat. Please log in.', 'error');
                        openModal(authModal); 
                        resetAuthFormToLoginMode(); 
                        console.error('New Chat failed: User not logged in (401).');
                    } else {
                        const result = await response.json();
                        displayMessage(result.error || 'Failed to start new chat.', 'error');
                        console.error('Failed to start new chat:', result.error || 'Unknown error');
                    }
                } catch (error) {
                    console.error('New Chat Error:', error);
                    displayMessage('An error occurred during new chat initiation.', 'error');
                }
            });
        }

        // File Upload Placeholder
        if (uploadBtn) {
            uploadBtn.addEventListener('click', () => {
                displayMessage('File upload functionality coming soon!', 'info');
                console.log('Upload button clicked. File upload logic would go here.');
            });
        }

        // Populate Chat Box on Page Load/Login
        async function populateChatBoxWithHistoryOrGreeting() {
            try {
                console.log('populateChatBoxWithHistoryOrGreeting: Fetching login status...');
                const response = await fetch('/check_login_status');
                const result = await response.json();
                console.log('populateChatBoxWithHistoryOrGreeting: Login status result:', result);

                if (chatBox) chatBox.innerHTML = ''; 

                if (response.ok && result.logged_in) {
                    console.log('populateChatBoxWithHistoryOrGreeting: User is logged in.');
                    updateSideMenu(true); // Show new chat button, profile, logout

                    if (profileDisplayName) profileDisplayName.textContent = result.username || 'N/A';
                    if (profileEmail) profileEmail.textContent = result.email || 'N/A';
                    if (profileDisplayNameInput) profileDisplayNameInput.value = result.username || '';
                    if (profileEmailInput) profileEmailInput.value = result.email || '';

                    const chatHistory = result.chat_history;
                    if (chatHistory && chatHistory.length > 0) {
                        console.log('populateChatBoxWithHistoryOrGreeting: Populating chat history...');
                        chatHistory.forEach(msg => {
                            if (msg.parts && Array.isArray(msg.parts) && msg.parts.length > 0 && typeof msg.parts[0] === 'string') {
                                addMessage(msg.role === 'model' ? 'bot' : 'user', msg.parts[0]);
                            } else {
                                console.warn("populateChatBoxWithHistoryOrGreeting: Skipping malformed chat history message:", msg);
                            }
                        });
                        console.log('populateChatBoxWithHistoryOrGreeting: Populated chat history for logged-in user. Messages:', chatHistory.length);
                    } else {
                        addMessage('bot', `Welcome back, ${result.username}! How can I help you today?`);
                        console.log('populateChatBoxWithHistoryOrGreeting: Displayed greeting for logged-in user (no history).');
                    }
                } else { // Not logged in (guest)
                    console.log('populateChatBoxWithHistoryOrGreeting: User is NOT logged in (guest).');
                    updateSideMenu(false); // Hide new chat button, show login link

                    guestMessageCount = result.guest_message_count || 0; 
                    if (messageLimitSpan) {
                         messageLimitSpan.textContent = MAX_GUEST_MESSAGES_FRONTEND - guestMessageCount;
                    }
                    console.log('populateChatBoxWithHistoryOrGreeting: Guest messages used (from backend):', guestMessageCount, 'Remaining (frontend display):', MAX_GUEST_MESSAGES_FRONTEND - guestMessageCount);

                    if (guestMessageCount < MAX_GUEST_MESSAGES_FRONTEND) {
                         addMessage('bot', `Hello! I'm Dave, your AI assistant. You have ${MAX_GUEST_MESSAGES_FRONTEND - guestMessageCount} free messages left. Please log in for unlimited access.`);
                    } else {
                        addMessage('bot', `Hello! I'm Dave, your AI assistant. You've used all your free messages. Please log in to continue chatting.`);
                        openModal(loginRequiredModal);
                    }
                    console.log('populateChatBoxWithHistoryOrGreeting: Displayed greeting for guest user.');
                }
            } catch (error) {
                console.error("Error during initial page load/login status check (populateChatBoxWithHistoryOrGreeting):", error);
                openModal(authModal); 
                resetAuthFormToLoginMode(); 
                updateSideMenu(false);
                if (chatBox) chatBox.innerHTML = ''; 
                addMessage('bot', `Hello! I'm Dave, your AI assistant. There was an issue loading your session. Please try logging in.`);
            }
        }

        // --- Event Listeners for Modals and Menu ---
        if (menuBtn) {
            menuBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                sideMenu.classList.toggle('open');
                console.log('Menu button clicked. Side menu state:', sideMenu.classList.contains('open') ? 'open' : 'closed');
            });
        }

        document.addEventListener('click', (event) => {
            if (sideMenu.classList.contains('open') && !menuContainer.contains(event.target)) {
                sideMenu.classList.remove('open');
                console.log('Clicked outside menu. Side menu closed.');
            }
        });

        // Event listeners for opening modals via menu links
        if (loginLink) loginLink.addEventListener('click', (e) => { 
            e.preventDefault(); 
            console.log('Login Link clicked. Opening authModal.'); 
            openModal(authModal);
            resetAuthFormToLoginMode(); 
        });
        if (profileLink) profileLink.addEventListener('click', (e) => { e.preventDefault(); console.log('Profile Link clicked.'); openModal(profileModal); });
        if (settingsLink) settingsLink.addEventListener('click', (e) => { e.preventDefault(); console.log('Settings Link clicked.'); openModal(settingsModal); });
        if (aboutLink) aboutLink.addEventListener('click', (e) => { e.preventDefault(); console.log('About Link clicked.'); openModal(aboutModal); });

        // Event listeners for closing modals (via their 'X' button)
        modalCloseBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modalToClose = e.target.closest('.modal-container');
                if (modalToClose) {
                    console.log('Close button clicked for modal:', modalToClose.id);
                    closeModal(modalToClose);
                }
            });
        });

        // Universal click handler for overlay to close active elements
        if (overlay) {
            overlay.addEventListener('click', () => {
                console.log('Overlay clicked.');
                if (authModal.classList.contains('open')) { closeModal(authModal); }
                if (profileModal.classList.contains('open')) { closeModal(profileModal); }
                if (settingsModal.classList.contains('open')) { closeModal(settingsModal); }
                if (aboutModal.classList.contains('open')) { closeModal(aboutModal); }
                if (loginRequiredModal.classList.contains('open')) { closeModal(loginRequiredModal); }
                const anyModalStillOpen = document.querySelectorAll('.modal-container.open').length > 0;
                if (sideMenu.classList.contains('open') && !anyModalStillOpen) {
                    sideMenu.classList.remove('open');
                }
            });
        }

        // Logout Link (moved to common listeners)
        if (menuLogoutLink) {
            menuLogoutLink.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    const response = await fetch('/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (response.ok) {
                        displayMessage('Logged out successfully.', 'success');
                        guestMessageCount = 0; // Reset client-side guest count on logout
                        window.location.href = '/'; // Redirect to home/login
                    } else {
                        const result = await response.json();
                        displayMessage(result.error || 'Failed to logout.', 'error');
                    }
                } catch (error) {
                    console.error('Logout Error:', error);
                    displayMessage('An error occurred during logout.', 'error');
                }
            });
        }


        // --- Initial Load/Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            loadThemePreference(); 
            populateChatBoxWithHistoryOrGreeting(); 
        });

        // --- Theme Toggling Logic (kept at bottom for organization) ---
        function applyTheme(isDarkMode) {
            if (isDarkMode) {
                document.documentElement.classList.add('dark-mode');
            } else {
                document.documentElement.classList.remove('dark-mode');
            }
        }

        function loadThemePreference() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                if (themeToggle) themeToggle.checked = true;
                applyTheme(true);
            } else if (savedTheme === 'light') {
                if (themeToggle) themeToggle.checked = false;
                applyTheme(false);
            } else {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (themeToggle) themeToggle.checked = prefersDark;
                applyTheme(prefersDark);
            }
        }

        if (themeToggle) {
            themeToggle.addEventListener('change', () => {
                const isDarkMode = themeToggle.checked;
                applyTheme(isDarkMode);
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            });
        }
        // --- End Theme Toggling Logic ---
    </script>
</body>
</html>
